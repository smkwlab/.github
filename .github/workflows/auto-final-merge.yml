---
# Reusable Workflow: Create Final PR to Main
#
# This workflow creates a PR to merge the final-tagged commit to main.
# Use this from other repositories with:
#
#   jobs:
#     create-final-pr:
#       uses: smkwlab/.github/.github/workflows/auto-final-merge.yml@v1
#
name: Create Final PR to Main

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr-to-main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Create PR to main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TAG_COMMIT=$(git rev-parse HEAD)

          # Get the branch name where the tag was pushed
          BRANCH_NAME=$(git branch -r --contains "$TAG_COMMIT" | grep -v HEAD | grep -vE '^\s*origin/main$' | head -1 | sed 's/origin\///' | xargs)

          if [ -z "$BRANCH_NAME" ]; then
            echo "::error::Cannot determine source branch for tag $TAG_NAME"
            exit 1
          fi

          echo "Creating PR from $BRANCH_NAME to main for tag $TAG_NAME"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists from $BRANCH_NAME to main"
            echo "Please review and merge the existing PR."
            exit 0
          fi

          # Create PR to main
          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Final Submission: $TAG_NAME" \
            --body "$(cat <<EOF
## 最終提出

タグ \`$TAG_NAME\` が付与されました。

このPRをレビューし、問題なければマージしてください。

- **タグ**: $TAG_NAME
- **ソースブランチ**: $BRANCH_NAME
- **コミット**: $TAG_COMMIT
EOF
)")

          echo "Created PR: $PR_URL"
          echo "Please review and merge the PR to complete the final submission."
