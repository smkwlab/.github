# Reusable Dependency Update Workflow
#
# Usage:
#   jobs:
#     dependency-update:
#       uses: smkwlab/.github/.github/workflows/dependency-update.yml@v1.1.0
#       secrets: inherit

name: Dependency Update (Reusable)

on:
  workflow_call:
    inputs:
      otp-version:
        description: 'OTP version'
        default: '28.2'
        required: false
        type: string
      elixir-version:
        description: 'Elixir version'
        default: '1.19.4'
        required: false
        type: string
      timeout-minutes:
        description: 'Job timeout in minutes'
        default: 30
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write

# Ensure only one dependency update runs at a time
concurrency:
  group: dependency-update
  cancel-in-progress: false

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    name: Update Dependencies

    steps:
    - name: Set up Git repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        otp-version: ${{ inputs.otp-version }}
        elixir-version: ${{ inputs.elixir-version }}

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: deps
        key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
        restore-keys: ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Update dependencies
      run: |
        mix deps.update --all
        mix deps.unlock --unused

    - name: Compile dependencies
      run: mix deps.compile

    - name: Run tests
      run: mix test
      continue-on-error: true
      id: test_run

    - name: Run format check
      run: mix format --check-formatted
      continue-on-error: true
      id: format_check

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> "$GITHUB_OUTPUT"
        else
          echo "changes=true" >> "$GITHUB_OUTPUT"
          # Generate detailed change summary
          {
            echo "CHANGE_SUMMARY<<EOF"
            echo "## Dependency Changes"
            echo ""
            git diff mix.lock | grep '^[+-]' | grep -v '^[+-]\{3\}' | head -20 || true
            echo "EOF"
          } >> "$GITHUB_ENV"
        fi

    - name: Create Pull Request
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "chore: weekly dependency update"
        body: |
          This is an automated pull request to update dependencies.

          ${{ env.CHANGE_SUMMARY }}

          ## Test Results
          - Tests: ${{ steps.test_run.outcome }}
          - Format: ${{ steps.format_check.outcome }}

          Please review the changes and ensure all tests pass before merging.

          ### Checklist
          - [ ] All tests pass
          - [ ] No breaking changes in dependencies
          - [ ] Security advisories addressed (if any)
        branch: dependency-update-${{ github.run_number }}
        delete-branch: true
        labels: |
          dependencies
          automated
